<Window
  x:Class="hyperactive.MainWindow"
  xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
  xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
  xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
  xmlns:git="clr-namespace:LibGit2Sharp;assembly=LibGit2Sharp"
  xmlns:local="clr-namespace:hyperactive"
  xmlns:mat="http://materialdesigninxaml.net/winfx/xaml/themes"
  xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
  Title="hyperactive"
  Width="1024"
  Height="768"
  d:DataContext="{d:DesignInstance Type=local:Repo,
                                   IsDesignTimeCreatable=True}"
  Background="{DynamicResource MaterialDesignPaper}"
  FontFamily="{DynamicResource MaterialDesignFont}"
  TextElement.FontSize="13"
  TextElement.FontWeight="Regular"
  TextElement.Foreground="{DynamicResource MaterialDesignBody}"
  TextOptions.TextFormattingMode="Ideal"
  TextOptions.TextRenderingMode="Auto"
  mc:Ignorable="d">
  <Window.Resources>
    <local:AndConverter x:Key="AndConverter" />

    <local:BoolToColorConverter x:Key="BoolToColorConverter" />

    <DataTemplate x:Key="FolderTemplate" DataType="{x:Type local:IDirectoryItem}">
      <StackPanel Orientation="Horizontal">
        <mat:PackIcon Kind="Folder" />
        <TextBlock Margin="8,0,0,0" Text="{Binding Name}" />
      </StackPanel>
    </DataTemplate>

    <DataTemplate x:Key="FileTemplate" DataType="{x:Type local:IDirectoryItem}">
      <StackPanel Orientation="Horizontal">
        <mat:PackIcon Kind="File" />
        <TextBlock Margin="8,0,0,0" Text="{Binding Name}" />
      </StackPanel>
    </DataTemplate>
  </Window.Resources>
  <Grid>
    <Grid.RowDefinitions>
      <RowDefinition Height="auto" />
      <RowDefinition Height="*" />
    </Grid.RowDefinitions>

    <mat:Card
      Grid.Row="0"
      Margin="16"
      Padding="8">
      <StackPanel>
        <Grid>
          <Grid.ColumnDefinitions>
            <ColumnDefinition />
            <ColumnDefinition Width="Auto" />
            <ColumnDefinition Width="Auto" />
          </Grid.ColumnDefinitions>

          <TextBox
            Name="txtDirectory"
            Grid.Column="0"
            mat:HintAssist.Hint="path to git repository"
            mat:TextFieldAssist.HasClearButton="True"
            mat:TextFieldAssist.HasLeadingIcon="True"
            mat:TextFieldAssist.LeadingIcon="Git"
            CaretBrush="{DynamicResource PrimaryHueLightBrush}"
            FontSize="16">
            <TextBox.Text>
              <Binding Path="Directory" UpdateSourceTrigger="PropertyChanged">
                <Binding.ValidationRules>
                  <local:ValidateGitDirectory />
                </Binding.ValidationRules>
              </Binding>
            </TextBox.Text>
          </TextBox>

          <Button
            Grid.Column="1"
            Margin="8,0,0,0"
            Command="{Binding SelectDirectoryCmd}"
            Content="{mat:PackIcon FolderOpen}"
            ToolTip="open git repository" />

          <Button
            Grid.Column="2"
            Margin="8,0,0,0"
            Command="{Binding LoadRepositoryCmd}"
            Content="{mat:PackIcon Reload}"
            ToolTip="reload git repository">
            <Button.IsEnabled>
              <MultiBinding Converter="{StaticResource AndConverter}">
                <Binding
                  Converter="{StaticResource NotConverter}"
                  ElementName="txtDirectory"
                  Path="(Validation.HasError)" />
                <Binding Path="IsLoaded" />
              </MultiBinding>
            </Button.IsEnabled>
          </Button>
        </Grid>

        <StackPanel Margin="0,16,0,0" Orientation="Horizontal">
          <StackPanel.IsEnabled>
            <MultiBinding Converter="{StaticResource AndConverter}">
              <Binding
                Converter="{StaticResource NotConverter}"
                ElementName="txtDirectory"
                Path="(Validation.HasError)" />
              <Binding Path="IsLoaded" />
            </MultiBinding>
          </StackPanel.IsEnabled>
          <TextBlock Text="local branches:" />
          <TextBlock Margin="8,0,0,0" Text="{Binding LocalBranchesCount}" />
          <TextBlock Margin="32,0,0,0" Text="remote branches:" />
          <TextBlock Margin="8,0,0,0" Text="{Binding RemoteBranchesCount}" />
          <TextBlock Margin="32,0,0,0" Text="status:" />
          <TextBlock
            Margin="8,0,0,0"
            FontFamily="Consolas"
            Foreground="{Binding Status.IsClean, Converter={StaticResource BoolToColorConverter}, Mode=OneWay}">
            <Run Text="{Binding Status.Head, Mode=OneWay}" />
            +<Run Text="{Binding Status.IdxAdd, Mode=OneWay}" />
            ~<Run Text="{Binding Status.IdxMod, Mode=OneWay}" />
            -<Run Text="{Binding Status.IdxDel, Mode=OneWay}" />
            !<Run Text="{Binding Status.IdxCon, Mode=OneWay}" />
            |
            +<Run Text="{Binding Status.WdirAdd, Mode=OneWay}" />
            ~<Run Text="{Binding Status.WdirMod, Mode=OneWay}" />
            -<Run Text="{Binding Status.WdirDel, Mode=OneWay}" />
            !<Run Text="{Binding Status.WdirCon, Mode=OneWay}" />
          </TextBlock>
        </StackPanel>
      </StackPanel>
    </mat:Card>

    <ItemsControl Grid.Row="1" ItemsSource="{Binding Branches}">
      <ItemsControl.IsEnabled>
        <MultiBinding Converter="{StaticResource AndConverter}">
          <Binding
            Converter="{StaticResource NotConverter}"
            ElementName="txtDirectory"
            Path="(Validation.HasError)" />
          <Binding Path="IsLoaded" />
        </MultiBinding>
      </ItemsControl.IsEnabled>
      <ItemsControl.ItemTemplate>
        <DataTemplate DataType="{x:Type local:IBranch}">
          <mat:Card Margin="16" Padding="16">
            <Grid>
              <Grid.RowDefinitions>
                <RowDefinition Height="auto" />
                <RowDefinition Height="200" />
                <RowDefinition Height="*" />
              </Grid.RowDefinitions>

              <TextBlock
                Grid.Row="0"
                Style="{DynamicResource MaterialDesignHeadline6TextBlock}"
                Text="{Binding Name}"
                TextAlignment="Center" />

              <ListBox
                Grid.Row="1"
                Margin="0,16,0,0"
                BorderBrush="{DynamicResource MaterialDesignLightSeparatorBackground}"
                BorderThickness="2"
                ItemsSource="{Binding CurrentDirectory}"
                SelectedItem="{Binding SelectedItem}">
                <ListBox.ItemTemplate>
                  <DataTemplate DataType="{x:Type local:IDirectoryItem}">
                    <ContentControl Content="{Binding}">
                      <ContentControl.Style>
                        <Style TargetType="{x:Type ContentControl}">
                          <Setter Property="ContentTemplate" Value="{StaticResource FileTemplate}" />
                          <Style.Triggers>
                            <DataTrigger Binding="{Binding Path=Type}" Value="{x:Static local:DirectoryItemType.Folder}">
                              <Setter Property="ContentTemplate" Value="{StaticResource FolderTemplate}" />
                            </DataTrigger>
                          </Style.Triggers>
                        </Style>
                      </ContentControl.Style>
                    </ContentControl>
                  </DataTemplate>
                </ListBox.ItemTemplate>
              </ListBox>

              <TextBox
                Grid.Row="2"
                Margin="0,16,0,0"
                VerticalContentAlignment="Stretch"
                AcceptsReturn="True"
                AcceptsTab="False"
                BorderBrush="{DynamicResource MaterialDesignLightSeparatorBackground}"
                BorderThickness="2"
                CaretBrush="{DynamicResource PrimaryHueLightBrush}"
                FontFamily="Consolas"
                HorizontalScrollBarVisibility="Auto"
                IsReadOnly="{Binding SelectedContent.ReadOnly}"
                Text="{Binding SelectedContent.Content}"
                TextWrapping="NoWrap"
                VerticalScrollBarVisibility="Auto" />
            </Grid>
          </mat:Card>
        </DataTemplate>
      </ItemsControl.ItemTemplate>
      <ItemsControl.ItemsPanel>
        <ItemsPanelTemplate>
          <UniformGrid Rows="1" />
        </ItemsPanelTemplate>
      </ItemsControl.ItemsPanel>
    </ItemsControl>

  </Grid>
</Window>
